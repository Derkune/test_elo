<html>
<meta name="viewport" content="width=device-width initial-scale=1 user-scalable=yes">
<head>
	<style>
	
	#wrapbox {
	  display: flex;
	  flex-wrap: wrap;
	  margin: auto;
	  display: flex;
	  justify-content: center;
	  /*max-width: 1100px;
	  min-height: 500px;
	  background-color: rgba(100, 200, 255, 0.5);
	  border-radius: 50px;*/
	}

	#title{
	  font-family: Sans-Serif;
	  line-height: 125%;
	  text-align: center;
	  margin:10;
	  color: white;
	  font-size: 48px;
	}
	
	.title2{
	  font-family: Sans-Serif;
	  margin:10 2;
	  text-align: center;
	  color: white;
	  font-size: 24px;
	}
	
	select{
	  background-color: rgb(75,75,75);
	  border-radius: 10px;
	  font-family: Sans-Serif;
	  text-align: center;
	  border: none;
	  font-weight: bold;
	  color: white;
	  font-size: inherit;
	}
	
	img {
	  width: 400px;
	  height: 400px;
	  object-fit: contain;
	}
	
	.line-break {
	  width: 100%;
	  margin: 0;
	}
	
	#plotBox { position:relative }
	
	svg { transform: translate(0, 0);}
	
	#legend{
		position:absolute;
		top:-2%;
		left:3%;
		color:black;
		font-family: Sans-Serif;
		font-size: 24px;
		font-weight: bold;
		z-index: 10;
	}
	
	.sidebar { opacity:0; width:100; height:100; position:fixed; right:0; display: block; z-index:9; }
	
	#menucheck:checked~#scorelink { opacity:1; top:100; transition: 0.15s linear; }
	#menucheck:checked~#discord { opacity:1; top:200; transition: 0.3s linear; }
	#menucheck:checked~#reddit { opacity:1; top:300; transition: 0.45s linear; }
	#menucheck:not(:checked)~.sidebar { top: 0; transition: 0.5s; }
	
	.gridimg {
	  width: 150px;
	  height: 150px;
	  object-fit: contain;
	}
	
	.griddiv {
	  flex-wrap: wrap;
	  justify-content: center;
	  width: 150px;
	  height: 175px;
	}
	
	.gridtxt{
		font-family: Sans-Serif;
		color:white;
		font-size: 12;
		margin:0 0;
	}
	
	</style>
</head>

<body style="min-width:700px; background-color:#000000;">
	
	<input type="checkbox" id="menucheck" style="display:none;"/>
	<label for="menucheck" style='display:inline-block;'><img id='menu' style='width:100; height:100; position:fixed; top:0; right:0; z-index:10;' src='Assets/menu.svg'></img></label>
	<img id='reddit' class='sidebar' onclick="navTo('https://old.reddit.com/r/chloe/')" src='Assets/reddit.svg'></img>
	<img id='discord' class='sidebar' onclick="navTo('https://discord.gg/TsBGYz4VTg')" src='Assets/discord.svg'>
	<img id='scorelink' class='sidebar' onclick="navTo('index.html')" src='Assets/ranklink.svg'></img>
	
	<div> <h1 id="title" >
		<select id="display" onchange="changeDisplay()">
		<option value="plot">Plot</option>
		<option value="sort">Sort</option>
		</select> with
		<select id="dataset" onchange="drawCanvas();popGrid(1);">
		<option value="nsfw">NSFW</option>
		<option value="user">User</option>
		</select> Ranking in 
		<select id="order" onchange="drawCanvas();popGrid(1);">
		<option value="elo">Elo Score</option>
		<option value="num">Image</option>
		<option value="char">Character</option>
		</select> Order </h1> </div>
	<div class="line-break"></div>
	

	
	<div id="wrapbox" min-width=770>	 
	  <div id="imgbox" class="plot"> <img id="simg" class="plot" style="border:2px solid #FFFFFF;" src="Assets/plotinfoblack.svg"> </div>
	  <div id="plotBox" class="plot"> <h1 id="legend" class="plot"></h1><svg id="plot" class="plot" height="400" style="border:2px solid #FFFFFF;" onmousemove="updateImg(event)"></svg></div>
	  <div class="line-break plot"></div>
	  <h1 class="title2 plot"> With 
		<select id="paint" class="plot"onchange="drawCanvas()">
		<option value="elo">Elo Score</option>
		<option value="char">Character</option>
		<option value="type">Char:Type</option>
		</select> Coloring</h1>
	  <h1 id="filter1txt" class="title2 grid" style="display:none;"> Filter for </h1>
		<select id="filter1" class="title2 grid" onchange="updateFilter()">
		<option value="All">All</option>
		</select>
		<h1 class="title2 grid" style="display:none;"> : </h1>
		<select id="filter2" class="title2 grid" onchange="updateFilter()">
		<option value="All">Any</option>
		<option value="Cat">Cat</option>
		<option value="Cosplay">Cosplay</option>
		<option value="Hoodie">Hoodie</option>
		<option value="None">None</option>
		</select>
	  <div class="line-break"></div>
	  
	</div>

	<script> 
		
		var ID2Elo = [0]; //Leading zero because IDs start at 1
		var ID2Char = [0]
		var Rank2ID = [];
		var storage = [[],[]]
		var xlim = 0;
		var sort = 'elo';
		var dataset = 'user';
		var paint = 'elo';
		var CharRank = [];
		var baseline = 200;
		var plot = document.getElementById('plot')
		var gridlen = 0;
		var filterchars = [];
		var chars = ['Chloe','Albino','Zoe','Lila','Iris','Willow','Colette','Amber','Claire','RPG','Fate'];
		
		function replaceOptions(select,list) {
			for (a in select.options) { select.options.remove(0); }
			for (c in list) {
				opt = document.createElement("option");
				opt.text=list[c]; opt.value=list[c];
				select.add(opt);
			}
		}
		
		function updateFilter() {
			const select = document.getElementById("filter1");
			const value = select.value;
			if (value=='All') {
				filterchars=[];
				replaceOptions(select,['All'].concat(chars));
			}
			else if (value=='+') {}
			else {
				if (value[0]=='-') {
					filterchars.splice(filterchars.indexOf(value.substring(2)),1);
				} else { filterchars.push(value) }
				if (filterchars.length) {
					optchars = []
					for (let i = 0; i < chars.length; i++) {
						if (filterchars.includes(chars[i])) { optchars.push('- '+chars[i]) }
						else { optchars.push(chars[i]) }
					}
					replaceOptions(select,['+','All'].concat(optchars))
				} else { replaceOptions(select,['All'].concat(chars)); }
			}
			document.getElementById("filter1txt").innerHTML='Filter for '+filterchars.join(' + ');
			popGrid(1)
		}

		function popGrid(from) {
			console.log('popGrid',from)
			let filtered = [];
			let type = document.getElementById("filter1").value
			let subtype = document.getElementById("filter2").value
			if (sort=='num') {
				for (let id = 1; id < ID2Char.length; id++) {
					tags = ID2Char[id].split(":");
					if (tags.length==1) { tags.push('None'); }
					if ((type=='All'||filterchars.includes(tags[0]))&&(subtype=='All'||subtype==tags[1])) { filtered.push(id) }
					if (filtered.length==gridlen) { break }
				}
				for (var i = from; i < gridlen+1; i++) {
					if (i > filtered.length){
						document.getElementById("gi"+i).style.display='none';
						document.getElementById("gt"+i).style.display='none';
					}
					else {
						id = filtered[i-1]
						document.getElementById("gi"+i).style.display='inherit';
						document.getElementById("gt"+i).style.display='inherit';
						document.getElementById("gi"+i).src='Images/'+id.toString().padStart(3,'0')+'.jpg';
						document.getElementById("gt"+i).innerHTML='#'+id+' '+ID2Char[id]+' '+ID2Elo[id];
					}
				}
			}
			if (sort=='elo') {
				for (let i = Rank2ID.length; i > 0 ; i--) {
					id = Rank2ID[i-1]
					tags = ID2Char[id].split(":");
					if (tags.length==1) { tags.push('None'); }
					if ((type=='All'||filterchars.includes(tags[0]))&&(subtype=='All'||subtype==tags[1])) { filtered.push(id) }
					if (filtered.length==gridlen) { break }
				}
				for (var i = from; i < gridlen+1; i++) {
					if (i > filtered.length){
						document.getElementById("gi"+i).style.display='none';
						document.getElementById("gt"+i).style.display='none';
					}
					else {
						id = filtered[i-1]
						document.getElementById("gi"+i).style.display='inherit';
						document.getElementById("gt"+i).style.display='inherit';
						document.getElementById("gi"+i).src='Images/'+id.toString().padStart(3,'0')+'.jpg';
						document.getElementById("gt"+i).innerHTML='#'+id+' '+ID2Char[id]+' '+ID2Elo[id];
					}
				}
			}				
		}
		
		function genGrid(len) {
			box = document.getElementById("wrapbox");
			for (var i = gridlen+1; i < gridlen+len+1; i++) {
				const newdiv = document.createElement("div");
				newdiv.setAttribute('id','gd'+i);
				newdiv.setAttribute('class','griddiv grid');
				const newimg = document.createElement("img");
				newimg.setAttribute('id','gi'+i);
				newimg.setAttribute('class','gridimg grid');
				const newtxt = document.createElement("h4");
				newtxt.setAttribute('id','gt'+i);
				newtxt.setAttribute('class','gridtxt grid');
				newtxt.innerHTML='Loading...';
				box.appendChild(newdiv);
				newdiv.appendChild(newimg); newdiv.appendChild(newtxt);
			}
			gridlen=len
			popGrid(1)
			updateFilter()
		}

		function changeDisplay() {
			if (document.getElementById('display').value=='sort'){
				if (!gridlen) { genGrid(60); }
				else { popGrid(1); }
				for (let part of document.getElementsByClassName('plot')) { part.style.display = 'none'; }
				for (let part of document.getElementsByClassName('grid')) { part.style.display = 'inherit'; }
				document.getElementById("order").remove(2);
			}
			else {
				for (let part of document.getElementsByClassName('plot')) { part.style.display = 'inherit'; }
				for (let part of document.getElementsByClassName('grid')) { part.style.display = 'none'; }
				optionchar = document.createElement("option");
				optionchar.text="Character"; optionchar.value="char";
				document.getElementById("order").add(optionchar);
			}
		}
		
		function navTo(uri) {window.open(uri);}
		
		var charColors = { //Note H,S in HSL
			Chloe: [215,100],
			Albino: [10,100],
			Zoe: [55,100],
			Lila: [285,100],
			Iris: [40,100],
			Willow: [85,75],
			Colette: [0,60],
			Amber: [45,25],
			Claire: [250,75],
			RPG: [0,0],
			Fate: [300,100]
		}		
		
		function charSort(){
			var groups = [[],[],[],[],[],[],[],[],[],[],[]];
			CharRank = [];
			for (var i = 0; i < xlim; i++) {
				var id = Rank2ID[i]
				group = chars.indexOf(ID2Char[id].split(':')[0])
				groups[group].push(id)
			}
			for (var i = 0; i < groups.length; i++) { CharRank.push.apply(CharRank,groups[i]) }
		}
		
		function drawLine(plot,x,y1,y2,color){
			let rect = document.createElementNS( "http://www.w3.org/2000/svg",'rect' );
			rect.setAttribute('class','bar');
			rect.setAttributeNS( null,'x',x-0.5 );
			rect.setAttributeNS( null,'width','2' );
			if (y2>y1){
				rect.setAttributeNS( null,'y',y1 );
				rect.setAttributeNS( null,'height',y2-y1 ); }
			else {
				rect.setAttributeNS( null,'y',y2 );
				rect.setAttributeNS( null,'height',y1-y2 );	}			
			rect.setAttributeNS( null,'fill',color);
			rect.setAttributeNS( null,'stroke','none');
			plot.appendChild(rect)
		}
		
		function updateImg(e){
			if (plot.lastChild == null) { return 0 } // Check if canvas is drawn yet 
			var x = Math.floor(e.clientX - plot.getBoundingClientRect().left - 1)
			if (x<0 || x>=xlim) { return } // Check mouse is inside canvas
			if (sort=='num') { x=x+1; id=x } 
			else if (sort=='elo') { var id = Rank2ID[x]; }
			else { var id = CharRank[x] }
			if (paint=='elo') { color = 'rgb(100,100,255)' }
			else { color = 'black' }
			plot.removeChild(plot.lastChild) // Remove last indicator
			drawLine(plot,x,baseline,400-0.4*(ID2Elo[id]-1000),color)
			var legendText = "Image "+id+"<br>"+ID2Char[id]+"<br>Elo "+ID2Elo[id]
			if (sort=='elo') { legendText = legendText+"<br>Rank "+x }
			document.getElementById("legend").innerHTML = legendText
			var simg = document.getElementById("simg"); // Update selection image
			simg.src='Images/'+id.toString().padStart(3,'0')+'.jpg';
		}
		
		function drawCanvas(){
			while (plot.lastChild) {
				plot.removeChild(plot.lastChild);
			}
			//plot = plot0.cloneNode(true); //Yeah this works but doesn't display...
			
			
			if (sort != document.getElementById("order").value) {
				sort = document.getElementById("order").value;
				if (sort=='char') { document.getElementById("paint").value = 'char'; }
			}
			paint = document.getElementById("paint").value;
			if (dataset != document.getElementById("dataset").value) {
				dataset = document.getElementById("dataset").value;
				document.getElementById("legend").innerHTML = ''
				if (dataset=='user') { getElo(0); }
				if (dataset=='nsfw') { getElo(1); }
			}
			xlim = Rank2ID.length
			plot.setAttribute('width',xlim)
			
			let rect = document.createElementNS( "http://www.w3.org/2000/svg","rect" );
			rect.setAttributeNS( null,'width',"100%");
			rect.setAttributeNS( null,'height',"100%");		
			rect.setAttributeNS( null,'fill','white');
			plot.appendChild(rect)
			
			for (var i = 0; i < xlim; i++) { // Draw each elo score as a bar plot
				if (sort=='char') { var id = CharRank[i] }
				else { var id = Rank2ID[i] }
				let score = ID2Elo[id];
				let r=0;
				let g=0;
				if (score>1500){ r = 10*Math.sqrt(score-1500) }
				else { g = 10*Math.sqrt(1500-score) }
				x=i
				baseline = 200
				if (sort=='num'){ x = id }
				if (paint=='elo') { color = 'rgb('+r.toString()+','+g.toString()+',0)' }
				else {
					Char = ID2Char[id];
					charColor = charColors[Char.split(':')[0]];
					let L=50;
					if (paint=='type'){
						let type = ID2Char[id].split(':')
						type = type[type.length-1]
						if (type=='Cat') { L=L-20 }
						if (type=='Hoodie') { L=L+15 }
						if (type=='Cosplay') { L=L+30 }
					}
					color = 'hsl('+charColor[0]+','+charColor[1]+'%,'+L+'%)'
					baseline = 400
				}
				
				drawLine(plot,x,baseline,400-0.4*(score-1000),color) // Red-green fade
			}
			drawLine(plot,0,0,0,'white') // Placeholder for indicator removal
		}
		
		function getElo(type){ // 0 user, 1 nsfw
			if (storage[type].length) {ID2Elo=storage[type][0]; ID2Char=storage[type][1]; Rank2ID=storage[type][2]; charSort(); return}
			document.getElementById("legend").innerHTML = 'Loading...'
			var xhr = new XMLHttpRequest();
			xhr.open("POST", 'https://script.google.com/macros/s/AKfycbytrbRXHOYt1NdJlCJO5baF9YK9HwL2RJ82yMe89FIHCxo9qjQjjJW-y5J36p_rKmGy/exec', true);
			xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
			xhr.onreadystatechange = function() { // Call a function when the state changes.
			if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
					ID2Elo=[0]; ID2Char=[0]; Rank2ID=[];
					var ratings = JSON.parse("[" + xhr.response + "]")[0];
					//console.log(ratings[0][2])
					for (var i = 0; i < ratings.length; i++) {
						ID2Elo.push(ratings[i][0]);
						ID2Char.push(ratings[i][1]);
						Rank2ID.push(ratings[i][2]);
					}
					storage[type][0]=ID2Elo; storage[type][1]=ID2Char; storage[type][2]=Rank2ID;
					drawCanvas()
					document.getElementById("legend").innerHTML = 'Loading Complete'
					charSort()
				}
			}
			if (type==0){ xhr.send("type=user"); }
			else if (type==1) { xhr.send("type=nsfw"); }
		}

		getElo(0)
	</script>


	
</body>
</html>
