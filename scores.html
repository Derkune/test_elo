<html>
<head>
	<style>
	.wrapbox {
	  display: flex;
	  flex-wrap: wrap;
	  margin: auto;
	  display: flex;
	  justify-content: center;
	  /*max-width: 1100px;
	  min-height: 500px;
	  background-color: rgba(100, 200, 255, 0.5);
	  border-radius: 50px;*/
	}

	#title{
	  font-family: Sans-Serif;
	  text-align: center;
	  margin:10;
	  color: white;
	  font-size: 48px;
	}
	
	img {
	  width: 400px;
	  height: 400px;
	  object-fit: contain;
	}
	
	
	.line-break {
	  width: 100%;
	  margin: 0;
	}
	
	</style>
</head>

<body style="background-color:#000000;">
	<script> 
		
		var Csrc = 0;
		var ratings = 0;
		var Cimg = new Image();
		var xlim;
		
		function updateImg(e){
			if (Csrc == 0) { return 0 } // Check if canvas is drawn yet
			var c = document.getElementById("plot");
			var rect = c.getBoundingClientRect()
			var ctx = c.getContext("2d");
			var x = Math.floor(e.clientX - rect.left)
			if (x<0 || x>=xlim) { return } // Check mouse is inside canvas
			ctx.drawImage(Cimg,0,0);
			var rating = ratings[x];
			ctx.beginPath(); // Draw the blue indicator line
			ctx.strokeStyle = 'rgb(100,100,255)';
			ctx.lineWidth = 2;
			ctx.moveTo(x,200);
			ctx.lineTo(x,400-0.4*(rating[1]-1000));
			ctx.stroke();
			ctx.closePath();
			ctx.fillStyle = "black"
			ctx.font = "48px sans-serif";
			ctx.fillText("Image: "+rating[0].toString(), 20, 50);
			ctx.fillText("Elo: "+rating[1].toString(), 20, 100);
			ctx.fillText("Rank: "+x.toString(), 20, 150);
			var simg = document.getElementById("simg"); // Update selection image
			simg.src='Images/'+rating[0].toString().padStart(3,'0')+'.jpg';
		}
		
		function drawCanvas(ratings){
			xlim = ratings.length
			console.log(xlim)
			var c = document.getElementById("plot");
			c.width = xlim;
			var ctx = c.getContext("2d");
			
			ctx.fillStyle = "white";
			ctx.fillRect(0, 0, xlim, 400)
			
			for (var i = 0; i < xlim; i++) { // Draw each elo score as a bar plot
				var score = ratings[i][1];
				var r=0;
				var g=0;
				if (score>1500){ r = 10*Math.sqrt(score-1500) }
				else { g = 10*Math.sqrt(1500-score) }
				ctx.beginPath();
				ctx.strokeStyle = 'rgb('+r.toString()+','+g.toString()+',0)'; // Red-green fade
				ctx.moveTo(i,200);
				ctx.lineTo(i,400-0.4*(score-1000));
				ctx.stroke();
				ctx.closePath();
			}
			return c.toDataURL()
		}
		
		function getElo(){
			var xhr = new XMLHttpRequest();
			xhr.open("GET", 'https://script.google.com/macros/s/AKfycbytrbRXHOYt1NdJlCJO5baF9YK9HwL2RJ82yMe89FIHCxo9qjQjjJW-y5J36p_rKmGy/exec', true);
			xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
			//xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
			xhr.onreadystatechange = function() { // Call a function when the state changes.
			if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
					ratings = JSON.parse("[" + xhr.response + "]")[0];
					Csrc = drawCanvas(ratings)
					Cimg.src=Csrc
				}
			}
			xhr.send("");
		}

		getElo()
	</script>

	<div class="wrapbox">
	  <div> <h1 id="title" > View Rankings in Order of Elo Score </h1> </div>
	  <div class="line-break"></div>
	  <div id="imgbox"> <img id="simg" style="border:2px solid #FFFFFF;" src="Assets/plotinfoblack.svg"> </div>
	  <div id="plotBox"> <canvas id="plot" height="400" style="border:2px solid #FFFFFF;" onmousemove="updateImg(event)"></canvas>
	</div>
	
</body>
</html>
