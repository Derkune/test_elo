<html>
<head>
	<style>
	.imgbox {
	  display: flex;
	  flex-wrap: wrap;
	  justify-content: center;
	}

	.imgbox > div {
	  background-color: rgba(255, 100, 50, 0.7);
	  width: 410px;
	  height: 450px;
	  margin: 20px;
	  text-align: center;
	  line-height: 75px;
	  font-size: 30px;
	  padding: 5px 0;
	}
	
	.imgbox> div:hover {
	  background-color: rgba(100, 255, 50, 0.7);
	  transition: 0.2s;
	}
	
	#title{
	  font-family: Sans-Serif;
	  text-align: center;
	  margin:0;
	  color: white;
	  font-size: 72px;
	}
	
	#infotitle{
	  font-family: Sans-Serif;
	  text-align: center;
	  margin:10;
	  color: white;
		font-size: 48px;
	}
	
	
	#info{
	  position: fixed;
	  height: 100%;
	  width: 100%;
	  justify-content: center;
	  background-color: rgba(50, 50, 50, 0.98);
	  z-index: 10;
	}
	
	#info.fade{
		transition: 1s;
		opacity: 0;
		visibility: hidden;
	}
	
	.bg-image{
	  background-image: url("Assets/Season1.jpg");
	  filter: blur(1.5px);
	  -webkit-filter: blur(1.5px);
	  height: 100%; 
	  background-position: center;
	  background-attachment: fixed;
	  background-repeat: no-repeat;
	  background-size: cover;
	  z-index: 1;
	}
	
	.content {
	  position: absolute;
	  left: 0;
	  right: 0;
	  z-index: 2;
	  margin-left: 20px;
	  margin-right: 20px;
	  justify-content: center;
	}
	
	img {
	  width: 400px;
	  height: 400px;
	  object-fit: contain;
	}
	
	.keypadbox {
	  display: flex;
	  justify-content: center;
	  margin: 0;
	}
	
	.infotext{
	  font-family: Sans-Serif;
	  text-align: center;
	  margin:0;
	  color: white;
	  font-size: 22px;
	}
		
	
	</style>
	
	<script>
	function makeid(length) {
		var result = '';
		var charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
		for ( var i = 0; i < length; i++ ) {
			result += charset.charAt(Math.floor(Math.random() * charset.length));
		}
		return result
	}
	var uid = makeid(5);
	console.log('Session ID:',uid);
	
	var noop = function(){};
	var images = [];
	var imgids = [];
	var index = 0;
	var ratings = 0;
	
	function getElo(){
			var xhr = new XMLHttpRequest();
			xhr.open("GET", 'https://script.google.com/macros/s/AKfycbytrbRXHOYt1NdJlCJO5baF9YK9HwL2RJ82yMe89FIHCxo9qjQjjJW-y5J36p_rKmGy/exec', true);
			xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
			//xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
			xhr.onreadystatechange = function() { // Call a function when the state changes.
			if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
					ratings = JSON.parse("[" + xhr.response + "]")[0];
				}
			}
			xhr.send("");
	}
	
	getElo()
	
	function getPairID(){
		if (ratings==0) { return getRandomID(1,680,2)}
		var max = ratings.length
		var shift = 0;
		var flag = 1;
		var search = 10
		while (flag){
			var a = Math.floor(Math.random() * (max - 3)) + 2 + shift; // exclude 2 from each end
			var d = Math.floor(2*search*Math.random()) - search; // Search +- 5
			if (d>=0){ d=d+1 } // Avoid zero
			var b = a + d
			if (b<0){ b=0 } // Clip ends, note this increases prob of ends in pair
			if (b>max+shift) { b=max+shift }
			if(imgids.indexOf(ratings[a][0]) === -1 && imgids.indexOf(ratings[b][0]) === -1){ flag = 0 }
		}
		console.log('Load Rankings:',a,b)
		return [ratings[a][0],ratings[b][0]]
	}
	
	function getRandomID(min,max,len) {
		var arr = [];
		while(arr.length < len){
			var r = Math.floor(Math.random() * (max - min + 1)) + min;
			if(imgids.indexOf(r) === -1 && arr.indexOf(r) === -1) arr.push(r);
		}
		return arr
	}
	
	imgids = imgids.concat(getPairID());
	
	function preloadImages(ids, imgs, callback) {
		var img;
		var remaining = ids.length;
		for (var i = 0; i < ids.length; i++) {
			img = new Image();
			img.onload = function() {
				--remaining;
				if (remaining <= 0) {
					callback();
				}
			};
			
			img.src = 'Images/'+ids[i].toString().padStart(3,'0')+'.jpg';
			console.log(img,ids[i])
			imgs.push(img);
		}
	}
	
	
	preloadImages(imgids,images,noop)
	
	</script>
</head>

<body style="background-color:#000000;">
	
	<div class="content">
	
	<!--<div style="display:flex; border-radius: 50px;; max-width: 1000px; justify-content:center; margin:auto; background-color: rgba(0, 0, 0, 0.5);">-->
	<h1 id="title">Elo Rate Chloe Pics</h1>
	<!--</div>-->

	<div class="imgbox">
	  <div id="A" onclick="send('A');next()"> <img id="imgA"> </div>
	  <div id="B" onclick="send('B');next()"> <img id="imgB"> </div>
	</div>
	
	<script type="text/javascript">
	  window.addEventListener("keydown", keylog)
	  function keylog(e){
		if (e.key=='a'){ send('A');next() }
		if (e.key=='d'){ send('B');next() }
		if (e.key=='w'){ send('T');next() }
		if (e.key=='s'){ next() }
	  }
	</script>
	<script> 
		var a = 100
		var b = 200
		var prepair
		index = -2
		
		function next(){
			index = index + 2
			if (imgids.length>50) {
				imgids=imgids.slice(-2);
				images=images.slice(-2);
				index = 0
			}
			prepair=getPairID();
			imgids=imgids.concat(prepair)
			document.getElementById("imgA").src = images[index].src;
			document.getElementById("imgB").src = images[index+1].src;
			document.getElementById("imgA").alt = images[index].src;
			document.getElementById("imgB").alt = images[index+1].src;
			preloadImages(prepair,images,noop);
		}
		
		next()
		
		function send(r){
			var xhr = new XMLHttpRequest();
			xhr.open("POST", 'https://script.google.com/macros/s/AKfycbytrbRXHOYt1NdJlCJO5baF9YK9HwL2RJ82yMe89FIHCxo9qjQjjJW-y5J36p_rKmGy/exec', true);
			xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
			//xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
			xhr.onreadystatechange = function() { // Call a function when the state changes.
			if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
				// Request finished. Do processing here.
				}
			}
			xhr.send("a="+imgids[index]+"&b="+imgids[index+1]+"&r="+r+"&uid="+uid);
		}
	</script>
	</div>
	
	<script>
	function clearinfo() {
	  document.getElementById("info").classList.toggle('fade');
	}
	</script>
	
	
	<div id="info" onclick="clearinfo()">
	  <h1 id="infotitle"> Instructions for Usage </h1>
	  <p class='infotext'> This webapp shows two images of Chloe for you to compare.<br>Choose the one that you prefer / like better / want to see more of.<br><br> You can click on the image or use the keypad as shown below.<br>If you can't decide, you can tie them or skip to the next pair.</p> 
	  <div class="keypadbox"><img src="Assets/keypadNB.svg" style="vertical-align:middle"></div>
	</div>
	
	
</body>
</html>
