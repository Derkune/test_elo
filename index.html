<html>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<head>
	<style>

	#title{
	  font-family: Sans-Serif;
	  text-align: center;
	  margin:0;
	  color: white;
	  font-size: 72px;
	}
	
	#desc{
	  font-family: Sans-Serif;
	  text-align: center;
	  margin:0;
	  color: white;
	  font-size: 24px;
	}
	
	#infotitle{
	  font-family: Sans-Serif;
	  text-align: center;
	  margin:10;
	  color: white;
	  font-size: 48px;
	}
	
	#info{
	  position: fixed;
	  height: 100%;
	  width: 100%;
	  justify-content: center;
	  background-color: rgba(50, 50, 50, 0.98);
	  z-index: 10;
	  visibility: hidden;
	}
	
	#info.fade{
		transition: 1s;
		opacity: 0;
		visibility: hidden;
	}
	
	.content {
	  position: absolute;
	  left: 0;
	  right: 0;
	  z-index: 2;
	  margin-left: 20px;
	  margin-right: 20px;
	  justify-content: center;
	}
	
	.wrapbox {
	  display: flex;
	  position:relative;
	  flex-wrap: wrap;
	  justify-content: center;
	}

	.imgbox {
	  display: flex;
	  background-color: rgb(238,62,84);
	  flex-wrap: wrap;
	  width: 400px;
	  margin: 15 20px;
	  padding: 10 10;
	  text-align: center;
	  justify-content: center;
	  border-radius: 10px;
	}
	
	.imgbox:hover {
	  background-color: rgb(147,188,57);
	  transition: 0.2s;
	}

	img {
	  width: 400px;
	  height: 400px;
	  object-fit: contain;
	}
	
	.imgdesc{
		position:relative;
		font-family: Sans-Serif;
		font-size: 22px;
		top:5;
		margin:0 10;
	}
	
	.select {
	  background-color: rgb(238,62,84);
	  border: none;
	  color: black;
	  margin: 15 20px;
	  padding: 15px 32px;
	  text-align: center;
	  text-decoration: none;
	  display: inline-block;
	  font-size: 16px;
	  border-radius: 10px;
	  font-family: Sans-Serif;
	  font-weight: bold;
	  font-size: 36px;
	  width: 190px;
	}
	
	.select:hover {
	  background-color: rgb(147,188,57);
	  transition: 0.2s;
	}
	
	.keypadbox {
	  display: flex;
	  justify-content: center;
	  margin: 0;
	}
	
	.infotext{
	  font-family: Sans-Serif;
	  text-align: center;
	  margin:0;
	  color: white;
	  font-size: 23px;
	}
	
	.line-break { width: 100%; margin: 0; }

	.sidebar { width:100; height:100; position:fixed; right:0; display: block; z-index:9; }
	
	#menucheck:checked~#scorelink { top:100; transition: 0.15s linear; }
	#menucheck:checked~#elotoggle { top:200; transition: 0.3s linear; }
	#menucheck:checked~#other { top:300; transition: 0.45s linear; }
	#menucheck:not(:checked)~.sidebar { top: 0; transition: 0.5s; }
		
	</style>
	
	<script>
	function makeid(length) {
		var result = '';
		var charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
		for ( var i = 0; i < length; i++ ) {
			result += charset.charAt(Math.floor(Math.random() * charset.length));
		}
		return result
	}
	var uid = makeid(5);
	console.log('Session ID:',uid);
	
	var noop = function(){};
	var images = [];
	var imgids = [];
	var index = 0;
	var ID2Elo = [0]; //Leading zero because IDs start at 1
	var ID2Char = [0]
	var Rank2ID = [];
	
	function getElo(){
			var xhr = new XMLHttpRequest();
			xhr.open("GET", 'https://script.google.com/macros/s/AKfycbytrbRXHOYt1NdJlCJO5baF9YK9HwL2RJ82yMe89FIHCxo9qjQjjJW-y5J36p_rKmGy/exec', true);
			xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
			xhr.onreadystatechange = function() { // Call a function when the state changes.
			if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
					var ratings = JSON.parse("[" + xhr.response + "]")[0];
					for (var i = 0; i < ratings.length; i++) {
						ID2Elo.push(ratings[i][0]);
						ID2Char.push(ratings[i][1]);
						Rank2ID.push(ratings[i][2]);
					}
					document.getElementById("eloA").innerHTML = 'Elo: '+ID2Elo[imgids[index]];
					document.getElementById("eloB").innerHTML = 'Elo: '+ID2Elo[imgids[index+1]];
					document.getElementById("charA").innerHTML = ID2Char[imgids[index]];
					document.getElementById("charB").innerHTML = ID2Char[imgids[index+1]];
				}
			}
			xhr.send("");
	}
	
	getElo()
	
	function getPairID(){
		if (Rank2ID.length==0) { return getRandomID(1,680,2)}
		var max = Rank2ID.length
		var shift = 0;
		var flag = 1;
		var search = 10
		while (flag){
			var a = Math.floor(Math.random() * (max - 3)) + 2 + shift; // exclude 2 from each end
			var d = Math.floor(2*search*Math.random()) - search; // Search +- 5
			if (d>=0){ d=d+1 } // Avoid zero
			var b = a + d
			if (b<0){ b=0 } // Clip ends, note this increases prob of ends in pair
			if (b>max+shift) { b=max+shift }
			if(imgids.indexOf(Rank2ID[a]) === -1 && imgids.indexOf(Rank2ID[b]) === -1){ flag = 0 }
		}
		console.log('Load Rankings:',a,b)
		return [Rank2ID[a],Rank2ID[b]]
	}
	
	function getRandomID(min,max,len) {
		//return [592,586] //Force first set to test
		var arr = [];
		while(arr.length < len){
			var r = Math.floor(Math.random() * (max - min + 1)) + min;
			if(imgids.indexOf(r) === -1 && arr.indexOf(r) === -1) arr.push(r);
		}
		return arr
	}
	
	imgids = imgids.concat(getPairID());
	
	function preloadImages(ids, imgs, callback) {
		var img;
		var remaining = ids.length;
		for (var i = 0; i < ids.length; i++) {
			img = new Image();
			img.onload = function() {
				--remaining;
				if (remaining <= 0) {
					callback();
				}
			};
			
			img.src = 'Images/'+ids[i].toString().padStart(3,'0')+'.jpg';
			console.log(img,ids[i])
			imgs.push(img);
		}
	}
	
	
	preloadImages(imgids,images,noop)
	
	</script>
</head>

<body style="background-color:#000000;">
	
	<h1 id='counter' style="color:white;font-family:Sans-Serif; font-size:24; position:fixed; top:0; left:10; z-index:8">Counter: 0</h1>
	
	<input type="checkbox" id="menucheck" style="display:none;"/>
	<label for="menucheck" style='display:inline-block;'><img id='menu' style='width:100; height:100; position:fixed; top:0; right:0; z-index:10;' src='Assets/menu.svg'></img></label>
	
	<img id='scorelink' class='sidebar' onclick="navScores()" src='Assets/scorelink.svg'></img>
	<img id='elotoggle' class='sidebar' onclick="eloToggle()" src='Assets/showelo.svg'></img>
	<!--<img id='other' class='sidebar' src='Assets/menu.svg'></img>-->
	
	
	
	<div class="content">
	<!--<div style="display:flex; border-radius: 50px;; max-width: 1000px; justify-content:center; margin:auto; background-color: rgba(0, 0, 0, 0.5);">-->
	<h1 id="title">Elo Rate Chloe Pics</h1>
	<p id="desc"> Choose the one that you prefer / like better / want to see more of </p>
	<!--</div>-->

	<div class="wrapbox">
	  <div class="imgbox" onclick="send('A');next()"> <img id="imgA"> <h4 id="idA" class="imgdesc"># ImageA</h4> <h4 id="charA" class="imgdesc">Loading...</h4> <h4 id="eloA" class="imgdesc" style="display:none">Elo: Loading</h4> </div>
	  <div class="imgbox" onclick="send('B');next()"> <img id="imgB"> <h4 id="idB" class="imgdesc"># ImageB</h4> <h4 id="charB" class="imgdesc">Loading...</h4> <h4 id="eloB" class="imgdesc" style="display:none">Elo: Loading</h4> </div>
	  <div class="line-break"></div>
	  <input type="button" class="select" value="= Tie =" onclick="send('T');next()">
	  <input type="button" class="select" value="< Skip >" onclick="next()">
	</div>
	
	<script type="text/javascript">
		window.addEventListener("keydown", keylog)
		function keylog(e){
			if (e.key=='a'){ send('A');next() }
			if (e.key=='d'){ send('B');next() }
			if (e.key=='w'){ send('T');next() }
			if (e.key=='s'){ next() }
		}
		
		var elovis = false
		function eloToggle() {
			if (elovis) { document.getElementById("eloA").style.display = 'none'; document.getElementById("eloB").style.display = 'none' }
			else { document.getElementById("eloA").style.display = 'block'; document.getElementById("eloB").style.display = 'block' }
			elovis = !elovis
		}
		
		function navScores() {window.open('scores.html');}
	  
		var a = 100;
		var b = 200;
		var prepair;
		var count = -1;
		index = -2
		
		function next(){
			index = index + 2
			if (imgids.length>50) {
				imgids=imgids.slice(-2);
				images=images.slice(-2);
				index = 0
			}
			prepair=getPairID();
			imgids=imgids.concat(prepair)
			document.getElementById("imgA").src = images[index].src;
			document.getElementById("imgB").src = images[index+1].src;
			document.getElementById("idA").innerHTML = '# '+imgids[index];
			document.getElementById("idB").innerHTML = '# '+imgids[index+1];
			document.getElementById("imgA").alt = images[index].src;
			document.getElementById("imgB").alt = images[index+1].src;
			if (Rank2ID.length>0){
				document.getElementById("charA").innerHTML = ID2Char[imgids[index]];
				document.getElementById("charB").innerHTML = ID2Char[imgids[index+1]];
				document.getElementById("eloA").innerHTML = 'Elo: '+ID2Elo[imgids[index]];
				document.getElementById("eloB").innerHTML = 'Elo: '+ID2Elo[imgids[index+1]];
			}
			preloadImages(prepair,images,noop);
		}
		
		next()
		
		function send(r){
			var xhr = new XMLHttpRequest();
			xhr.open("POST", 'https://script.google.com/macros/s/AKfycbytrbRXHOYt1NdJlCJO5baF9YK9HwL2RJ82yMe89FIHCxo9qjQjjJW-y5J36p_rKmGy/exec', true);
			xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
			//xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
			xhr.onreadystatechange = function() { // Call a function when the state changes.
			if (this.readyState === XMLHttpRequest.DONE && this.status === 200) {
				// Request finished. Do processing here.
				}
			}
			xhr.send("a="+imgids[index]+"&b="+imgids[index+1]+"&r="+r+"&uid="+uid);
			count = count + 1;
			document.getElementById("counter").innerHTML = 'Counter '+count;
		}
	</script>
	</div>
	
	<script>
	function clearinfo() {
	  document.getElementById("info").classList.toggle('fade');
	}
	</script>
	
	
	<div id="info" onclick="clearinfo()">
	  <h1 id="infotitle"> Instructions </h1>
	  <p class='infotext'> <br>This webapp shows two images of Chloe for you to compare.<br>Choose the one that you prefer / like better / want to see more of.<br><br> You can click on the image or use the keypad as shown below.<br>If you can't decide, you can tie them or skip to the next pair.</p> 
	  <div class="keypadbox"><img src="Assets/keypadNB.svg" style="vertical-align:middle"></div>
	</div>
	
	
</body>
</html>
